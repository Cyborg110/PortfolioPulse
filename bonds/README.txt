Модуль bonds — самый сложный и самый важный модуль проекта.
Полноценная работа с корпоративными, ОФЗ, муниципальными и еврооблигациями.
Считает всё, что нужно для профессионального сравнения и ранжирования облигаций.

Структура модуля
├── __init__.py        → re-export Bond, Bonds
├── models.py          → основной класс Bond + контейнер Bonds
├── database.py        → таблица bonds (все метаданные + номинал, амортизация и т.д.)
└── README.txt         ← ты читаешь его сейчас

================================================================================
Главный класс: Bond
================================================================================

Наследует BaseAsset → полностью совместим с Stock/Etf по интерфейсу.

Ключевые поля (всё берётся из БД + API Тинькофф):
• ticker, figi, name
• currency, nominal, nominal_currency
• initial_nominal, initial_nominal_currency
• coupon_quantity_per_year
• maturity_date, placement_date
• floating_coupon_flag, amortization_flag
• aci_value (НКД), aci_value_currency
• sector, country_of_risk, risk_level (вручную заполняется)

Подмодули:
• self.candles  → MultiTimeframeCandles (factor = nominal/100 → цены в % от номинала)
• self.payments → Coupons (объект из payments/coupons.py)

================================================================================
Все метрики, которые считает Bond.calculate_metrics()
================================================================================

1. Из candles (дневной таймфрейм, цены в % от номинала)
   • volatility, sharpe_ratio, max_drawdown, atr_14 и др.

2. Из payments (Coupons)
   • amount_year                → ожидаемый годовой купон в валюте номинала
   • average_amount
   • is_approximate             → True при floating + amortization одновременно

3. Специфичные для облигаций (считаются в Bond.calculate_metrics())
   • current_yield              → amount_year / текущая_цена_с_НКД × 100%
   • total_return               → (все будущие купоны + номинал) / текущая_цена_с_НКД – 1
   • ytm                        → доходность к погашению/оферте (NPV = 0)
   • macaulay_duration          → дюрация Маколея (в годах)
   • price_drop_on_1pct         → на сколько упадёт цена при росте ставки на 1 п.п.
   • days_to_maturity           → дней до погашения

   → При floating_coupon_flag + amortization_flag = True
     все доходности (ytm, duration и т.д.) помечаются как приблизительные

================================================================================
Как пользоваться
================================================================================

Одиночная облигация:
    bond = Bond("RU000A105B92")
    await bond.update_candles()          # если нужно свежие цены
    await bond.update_payments()         # купоны (раз в сутки)
    bond.calculate_metrics()            # ← ВСЁ СЧИТАЕТСЯ ЗДЕСЬ

    print(f"YTM: {bond.ytm:.2f}%")
    print(f"Дюрация: {bond.macaulay_duration:.2f} лет")
    print(f"Годовой купон: {bond.payments.amount_year:.2f}")

Массовый анализ (best_bonds):
    bonds = Bonds(filters={"currency": "rub"})
    await bonds.update_candles(sleep=0.05)
    await bonds.update_payments(sleep=0.05)
    bonds.calculate_metrics()

    for bond in sorted(bonds.bonds,
                       key=lambda b: b.ytm or 0,
                       reverse=True)[:30]:
        print(bond)

================================================================================
Критически важные детали
================================================================================

1. Цены в свечах — в % от номинала
   → factor = nominal / 100
   → 101.5 = 101.5% от номинала

2. Автоматическая конвертация в RUB
   Если валюта ≠ "rub" → в calculate_metrics() вызывается:
       converter.convert(candles, currency, "rub")
       converter.convert(payments, currency, "rub")
   → Если валюта не поддерживается (например JPY) — остаётся как есть (без падения)

3. НКД (aci_value) всегда добавляется к цене при расчётах YTM и current_yield

4. update_payments() → до maturity_date + 1 день
   → гарантирует, что все будущие купоны загружены

5. Для плавающих купонов с амортизацией:
   • amount_year считается с весами 70% future / 30% historical
   • YTM считается приближённо → bond.is_yield_approximate = True

================================================================================
Что где используется в проекте
================================================================================

• best_bonds.py — главная сортировка по YTM, current_yield, дюрации
• Скоро будет: фильтры по дюрации, по риску, по секторам
• Планируется: сигналы на покупку при YTM > ключевая ставка + спред

================================================================================
Итог
================================================================================

Модуль bonds — полностью готовый к бою:
• Все облигации (ОФЗ, корпоративки, еврооблигации) обрабатываются одинаково
• Все ключевые метрики считаются автоматически одним вызовом calculate_metrics()
• Конвертация валют — безопасная (не падает на экзотических валютах)
• Поддержка плавающих купонов и амортизации с понятным флагом приближённости

Работаете с облигацией точно так же, как с акцией:
    bond.candles  → волатильность, шерп и т.д.
    bond.payments → годовой купон
    bond.ytm, bond.macaulay_duration → главные метрики для сравнения

Никаких ручных расчётов, никаких сюрпризов — просто вызываете и получаете готовые цифры.